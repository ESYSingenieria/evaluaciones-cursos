<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmaci贸n de Pago</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>
<body>
    <header style="text-align: center; padding: 0px; background-color: #ffffff;">
        <a href="https://esys.cl/"> <!-- Enlace al logo -->
            <img src="logo.png" alt="Logo de la Empresa" style="max-width: 200px; height: auto;">
        </a>
    </header>
    
    <h2>Pago Confirmado</h2>
    <p>Ingresa los datos de los inscritos para el curso</p>
    
    <form id="inscription-form">
        <label for="course">Curso:</label>
        <select id="course" required></select>
        
        <label for="date">Fecha de Inscripci贸n:</label>
        <select id="date" required></select>
        
        <div id="inscription-fields"></div>
        
        <button type="submit">Confirmar Inscripci贸n</button>
    </form>
    
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const purchasedCourses = JSON.parse(urlParams.get("courses"));
            const courseSelect = document.getElementById("course");
            const dateSelect = document.getElementById("date");
            const inscriptionFields = document.getElementById("inscription-fields");
            
            purchasedCourses.forEach(course => {
                const option = document.createElement("option");
                option.value = course.id;
                option.textContent = `${course.name} - ${course.quantity} cupos`;
                courseSelect.appendChild(option);
            });
            
            courseSelect.addEventListener("change", async function () {
                const courseId = this.value;
                dateSelect.innerHTML = "";
                const snapshot = await db.collection("courses").doc(courseId).get();
                const dates = snapshot.data().availableDates || [];
                
                dates.forEach(date => {
                    const option = document.createElement("option");
                    option.value = date;
                    option.textContent = date;
                    dateSelect.appendChild(option);
                });
            });
            
            document.getElementById("inscription-form").addEventListener("submit", async function (e) {
                e.preventDefault();
                const courseId = courseSelect.value;
                const selectedDate = dateSelect.value;
                const numSlots = purchasedCourses.find(c => c.id === courseId).quantity;
                
                let inscriptions = [];
                for (let i = 0; i < numSlots; i++) {
                    const name = prompt(`Nombre del inscrito ${i + 1}:`);
                    const rut = prompt(`RUT del inscrito ${i + 1}:`);
                    const email = prompt(`Correo del inscrito ${i + 1}:`);
                    const company = prompt(`Empresa del inscrito ${i + 1} (opcional):`) || "";
                    inscriptions.push({ name, rut, email, company });
                }
                
                const docRef = db.collection("inscriptions").doc(`${courseId}_${selectedDate}`);
                const docSnap = await docRef.get();
                
                if (docSnap.exists) {
                    const data = docSnap.data();
                    await docRef.update({
                        participants: firebase.firestore.FieldValue.arrayUnion(...inscriptions),
                        totalInscritos: data.totalInscritos + numSlots,
                        totalPagado: data.totalPagado + purchasedCourses.find(c => c.id === courseId).price * numSlots
                    });
                } else {
                    await docRef.set({
                        courseId,
                        fecha: selectedDate,
                        participants: inscriptions,
                        totalInscritos: numSlots,
                        totalPagado: purchasedCourses.find(c => c.id === courseId).price * numSlots
                    });
                }
                
                alert("Inscripci贸n confirmada correctamente.");
                window.location.href = "https://esysingenieria.github.io/evaluaciones-cursos/tienda_cursos.html";
            });
        });
    </script>
</body>
</html>