<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verificación de Insignia</title>

  <link rel="stylesheet" href="styles.css"/>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

  <!-- (IMPORTANTE) NO cargar app.js aquí para evitar redirecciones -->
  <!-- <script src="app.js" defer></script> -->

  <!-- Firebase mínimo + loadBadgeData local (solo para esta página pública) -->
  <script>
    // ===== Firebase minimal (página pública de verificación) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBikggLtX1nwc1OXWUvDKXFm6P_hAdAe-Y",
      authDomain: "plataforma-de-cursos-esys.firebaseapp.com",
      projectId: "plataforma-de-cursos-esys",
      storageBucket: "plataforma-de-cursos-esys.firebasestorage.app",
      messagingSenderId: "950684050808",
      appId: "1:950684050808:web:33d2ef70f2343642f4548d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== Lógica local para mostrar el certificado por ?id =====
    async function loadBadgeData(){
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) return; // landing, sin detalle

      // Referencias a elementos
      const imgEl   = document.getElementById('badgeImage');
      const nameEl  = document.getElementById('courseName');
      const toEl    = document.getElementById('issuedTo');
      const descEl  = document.getElementById('description');
      const critUL  = document.getElementById('criteriaList');
      const stdUL   = document.getElementById('standardsList');

      // Map de imágenes (sin instructores)
      const BADGE_FILES = {
        sf6:  'SF6_badge.png',
        e70e: 'NFPA70E_2024_badge.png',
        e70b: 'NFPA70B_2023_badge.png'
      };
      const getBadgeSrc = (courseName='')=>{
        const n = courseName.toLowerCase();
        if (/sf6/.test(n)) return BADGE_FILES.sf6;
        if (/70e/.test(n)) return BADGE_FILES.e70e;
        if (/70b/.test(n)) return BADGE_FILES.e70b;
        return 'logo.png';
      };

      try{
        const doc = await db.collection('certificates').doc(id).get();
        if (!doc.exists){
          nameEl.textContent = 'Certificado no encontrado';
          toEl.textContent   = '';
          descEl.textContent = 'Verifica que el ID esté correctamente escrito.';
          imgEl.src = 'logo.png';
          critUL.innerHTML = '<li>—</li>';
          stdUL.innerHTML  = '<li>—</li>';
          return;
        }
        const d = doc.data() || {};

        // Título y destinatario
        const courseName = (d.courseName || 'Curso').trim();
        const issuedTo   = (d.name || '—').trim();
        nameEl.textContent = courseName;
        toEl.textContent   = `Emitido a: ${issuedTo}`;

        // Descripción
        descEl.textContent = d.description || 'Certificado emitido por ESYS Ingeniería.';

        // Imagen
        imgEl.src = getBadgeSrc(courseName);
        imgEl.onerror = ()=> imgEl.src = 'logo.png';

        // Listas
        const criteria  = Array.isArray(d.criteria)  ? d.criteria  : (d.criteria  ? [d.criteria]  : []);
        const standards = Array.isArray(d.standards) ? d.standards : (d.standards ? [d.standards] : []);
        const toLi = arr => (arr.length ? arr.map(x=>`<li>${x}</li>`).join('') : '<li>—</li>');
        critUL.innerHTML = toLi(criteria);
        stdUL.innerHTML  = toLi(standards);
      }catch(err){
        console.error('Error cargando certificado:', err);
        nameEl.textContent = 'Error al cargar';
        descEl.textContent = 'Intenta nuevamente en unos segundos.';
        imgEl.src = 'logo.png';
        critUL.innerHTML = '<li>—</li>';
        stdUL.innerHTML  = '<li>—</li>';
      }
    }
  </script>

  <style>
    .badge-container{
      max-width: 800px; margin: 30px auto; padding: 20px; background:#fff;
      border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1);
    }
    .badge-header{ text-align:center; margin-bottom:20px; }
    .badge-header img{ width:150px; height:auto; margin-bottom:10px; }
    .badge-content{ text-align:center; margin-bottom:20px; }
    .badge-content h2{ margin-bottom:10px; font-size:1.5rem; color:#007bff; }
    .badge-content p{ margin-bottom:15px; color:#555; }
    .badge-criteria, .badge-standards{ margin-top:25px; }
    .badge-criteria h3, .badge-standards h3{ color:#333; margin-bottom:10px; font-size:1.1rem; }
    .badge-criteria ul, .badge-standards ul{
      list-style: none; padding:0; margin:0;
    }
    .badge-criteria ul li, .badge-standards ul li{
      background:#f9f9f9; margin-bottom:10px; padding:10px;
      border-radius:5px; box-shadow:0 1px 4px rgba(0,0,0,.1);
    }
    .badge-footer{ text-align:center; margin-top:30px; }
    .badge-footer button{
      background-color:#28a745; color:#fff; border:0; padding:10px 20px;
      border-radius:5px; cursor:pointer; font-size:16px;
    }
    .badge-footer button:hover{ background-color:#218838; }
    .badge-footer a{ display:block; margin-top:10px; color:#007bff; text-decoration:none; font-size:14px; }
    .badge-footer a:hover{ text-decoration:underline; }

    /* ====== Buscador ====== */
    .search-wrap{
      position:relative;
      margin: 0 0 18px 0;
      box-sizing: border-box;
    }
    .search-input{
      width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; font-size:16px; outline:none;
    }
    .search-input:focus{ border-color:#007bff; box-shadow:0 0 0 3px rgba(0,123,255,.15); }
    .search-results{
      position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #e5e7eb;
      border-top:none; border-radius:0 0 12px 12px; box-shadow:0 10px 24px rgba(0,0,0,.08);
      max-height:360px; overflow:auto; display:none; z-index:50;
    }
    .search-results.open{ display:block; }
    .sr-item{ padding:10px 12px; cursor:pointer; }
    .sr-item:hover{ background:#f8fafc; }
    .sr-item.disabled{ cursor:default; color:#6b7280; }
    .sr-title{ font-weight:600; }
    .sr-sub{ font-size:12px; color:#4b5563; }
    .sr-meta{ font-size:11px; color:#9ca3af; margin-top:2px; }
    .search-hint{ font-size:12px; color:#6b7280; margin-top:6px; }

    /* ====== Landing (sin ?id) ====== */
    .landing-title{
      display:none; text-align:center; font-weight:700; color:#374151;
      margin: 4px 0 12px; font-size:26px;
    }
    .badges{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 190px));
      justify-content: center;
      gap:20px; margin: 6px 0 22px 0;
    }
    .badge-card{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      padding:16px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,.04);
    }
    .badge-card img{ max-width:150px; height:auto; display:block; margin:0 auto 10px; }
    .badge-card .bc-title{ font-size:13px; color:#374151; line-height:1.25; }

    /* barra más pequeña en landing (no se sale del contenedor) */
    .search-wrap.landing-width{
      width: calc(100% - 40px);
      margin-left:auto; margin-right:auto;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <header style="text-align:center; padding:0; background:#ffffff;">
    <a href="https://esys.cl/"><img src="logo.png" alt="ESYS" style="max-width:200px;height:auto;"></a>
  </header>

  <div class="badge-container">
    <!-- Título y mosaico (solo cuando NO hay ?id) -->
    <h2 id="landingTitle" class="landing-title">Certificaciones de Cursos</h2>
    <div id="badgesGrid" class="badges" style="display:none;"></div>

    <!-- Buscador -->
    <div class="search-wrap">
      <input id="globalSearch" class="search-input"
           placeholder="Buscar por Nombre o por ID de Usuario…" autocomplete="off"/>
      <div id="searchResults" class="search-results"></div>
      <div class="search-hint">Tip: El ID del usuario se puede encontrar en el certificado en la sección ID luego de los dos primeros dígitos. Ej.: (02"99"-2025) - ID Usuario = 99.</div>
    </div>
    
    <!-- Detalle (solo con ?id) -->
    <div id="detailSection">
      <div class="badge-header">
        <img id="badgeImage" src="" alt="Insignia">
        <h1 id="courseName">Cargando...</h1>
      </div>

      <div class="badge-content">
        <p id="issuedTo">Cargando...</p>
        <p id="description">Cargando...</p>
      </div>

      <div class="badge-criteria">
        <h3>Criterios de Aprobación</h3>
        <ul id="criteriaList">
          <li>Cargando...</li>
        </ul>
      </div>

      <div class="badge-standards">
        <h3>Estándares</h3>
        <ul id="standardsList">
          <li>Cargando...</li>
        </ul>
      </div>

      <div class="badge-footer">
        <button onclick="window.location.href='https://esys.cl/cursos-y-capacitaciones/'">Obtener esta Insignia</button>
      </div>
    </div>
  </div>

  <!-- Buscador (con nombre insensible a mayúsculas) -->
  <script>
    (function initVerifierSearchV2(){
      const input = document.getElementById('globalSearch');
      const panel = document.getElementById('searchResults');
      if(!input || !panel) return;

      // helpers
      const open  = ()=> panel.classList.add('open');
      const close = ()=> { panel.classList.remove('open'); panel.innerHTML=''; };
      const render = (items)=>{
        if(!items.length){ panel.innerHTML = '<div class="sr-item disabled">Sin resultados</div>'; open(); return; }
        panel.innerHTML = items.map(it => `
          <div class="sr-item ${it.disabled?'disabled':''}" ${it.id?`data-id="${it.id}"`:''}>
            <div class="sr-title">${it.title}</div>
            <div class="sr-sub">${it.sub||''}</div>
            ${it.meta?`<div class="sr-meta">${it.meta}</div>`:''}
          </div>
        `).join('');
        open();
      };

      // navegación por clic y enter
      panel.addEventListener('click', e=>{
        const item = e.target.closest('.sr-item');
        if(!item || item.classList.contains('disabled')) return;
        const id = item.dataset.id;
        if(id) window.location.href = `verificar.html?id=${id}`;
      });
      input.addEventListener('keydown', e=>{
        if(e.key==='Enter'){
          const first = panel.querySelector('.sr-item:not(.disabled)');
          if(first && first.dataset.id) window.location.href = `verificar.html?id=${first.dataset.id}`;
        }
      });
      document.addEventListener('click', e=>{
        if(!panel.contains(e.target) && e.target!==input) close();
      });

      // debounce
      let to=null;
      input.addEventListener('input', ()=>{
        clearTimeout(to);
        const q = input.value.trim();
        if(!q){ close(); return; }
        panel.innerHTML = '<div class="sr-item disabled">Buscando…</div>'; open();
        to = setTimeout(()=> doSearch(q), 260);
      });

      async function doSearch(raw){
        try{
          const items = [];
          const onlyDigits = /^[0-9]+$/.test(raw.replace(/[^\d]/g,''));

          // --- 1) Búsqueda por CustomID (solo números) ---
          if(onlyDigits){
            let cid = raw.replace(/[^\d]/g,'');
            if(!cid.endsWith('-')) cid += '-';

            const usersSnap = await db.collection('users')
              .orderBy('customID')
              .startAt(cid)
              .endAt(cid + '\uf8ff')
              .limit(5)
              .get();

            if (usersSnap.empty){
              items.push({disabled:true, title:`${cid}`, sub:'Sin usuarios con ese CustomID'});
            }else{
              for(const uDoc of usersSnap.docs){
                const u = uDoc.data() || {};
                const uname = (u.name||'').trim();
                const uCID  = u.customID || cid;

                const certSnap = await db.collection('certificates')
                  .orderBy('name')
                  .startAt(uname)
                  .endAt(uname + '\uf8ff')
                  .limit(6)
                  .get();

                if(certSnap.empty){
                  items.push({disabled:true, title:`${uCID} — ${uname}`, sub:'Sin certificados asociados'});
                }else{
                  certSnap.forEach(c=>{
                    const d = c.data() || {};
                    items.push({
                      id: c.id,
                      title: d.courseName || 'Curso',
                      sub: `${uCID} — ${d.name || uname}`,
                      meta: `ID certificado: ${c.id}`
                    });
                  });
                }
              }
            }
          }

          // --- 2) Búsqueda por NOMBRE (case-insensitive con dos prefijos) ---
          const termLower = raw.toLowerCase();
          const termCap   = raw.replace(/\b\w/g, ch => ch.toUpperCase());

          async function queryByNamePrefix(prefix){
            const snap = await db.collection('certificates')
              .orderBy('name')
              .startAt(prefix)
              .endAt(prefix + '\uf8ff')
              .limit(8)
              .get();
            const out = [];
            snap.forEach(doc=>{
              const d = doc.data()||{};
              out.push({
                id: doc.id,
                title: d.courseName || 'Curso',
                sub: d.name || '',
                meta: `ID certificado: ${doc.id}`
              });
            });
            return out;
          }

          const [byLower, byCap] = await Promise.all([
            queryByNamePrefix(termLower),
            queryByNamePrefix(termCap)
          ]);
          const map = new Map();
          [...byLower, ...byCap].forEach(r => { if(!map.has(r.id)) map.set(r.id, r); });
          items.push(...map.values());

          // --- quitar duplicados y renderizar ---
          const seen = new Set(); const uniq=[];
          for(const it of items){
            if(!it.id){ uniq.push(it); continue; }
            if(seen.has(it.id)) continue;
            seen.add(it.id); uniq.push(it);
          }
          render(uniq.slice(0,12));
        }catch(err){
          console.error('Search error:', err);
          render([{disabled:true, title:'Error de búsqueda', sub:'Intenta nuevamente'}]);
        }
      }
    })();
  </script>

  <!-- Con/sin ?id: mostrar detalle o landing + insignias y ajustar ancho del buscador -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const params = new URLSearchParams(location.search);
        const hasId  = params.has('id');

        const detail = document.getElementById('detailSection');
        const grid   = document.getElementById('badgesGrid');
        const title  = document.getElementById('landingTitle');
        const searchWrap = document.querySelector('.search-wrap');

        // Imágenes válidas para mostrar en la landing (sin instructores)
        const BADGE_FILES = {
          sf6: 'SF6_badge.png',
          e70e: 'NFPA70E_2024_badge.png',
          e70b: 'NFPA70B_2023_badge.png'
        };

        const getBadgeSrc = (courseName='') => {
          const n = courseName.toLowerCase();
          if (/sf6/.test(n)) return BADGE_FILES.sf6;
          if (/70e/.test(n)) return BADGE_FILES.e70e;
          if (/70b/.test(n)) return BADGE_FILES.e70b;
          return 'logo.png';
        };

        // Ajuste de barra en landing
        const fitSearchLanding = () => {
          if (!searchWrap) return;
          searchWrap.classList.add('landing-width');
        };

        if (hasId) {
          // Detalle
          if (typeof loadBadgeData === 'function') loadBadgeData();
          if (grid) grid.style.display = 'none';
          if (title) title.style.display = 'none';
          if (searchWrap) { searchWrap.classList.remove('landing-width'); searchWrap.style.width = ''; }
        } else {
          // Landing
          if (detail) detail.style.display = 'none';
          if (title) title.style.display = 'block';
          if (grid) {
            grid.style.display = 'grid';
            try{
              const snap = await db.collection('certificates')
                .orderBy('courseName')
                .limit(120)
                .get();

              const byCourse = new Map();
              snap.forEach(doc=>{
                const d = doc.data()||{};
                const course = (d.courseName||'Curso').trim();

                if (/instructor/i.test(course)) return; // <-- ocultar instructores
                if (byCourse.has(course)) return;

                byCourse.set(course, getBadgeSrc(course));
              });

              grid.innerHTML = [...byCourse.entries()].map(([course, img])=>`
                <div class="badge-card">
                  <img src="${img}" alt="${course}" onerror="this.src='logo.png'">
                  <div class="bc-title">${course}</div>
                </div>
              `).join('');

              fitSearchLanding();
            }catch(e){
              console.error('Error cargando insignias:', e);
            }
          } else {
            fitSearchLanding();
          }
        }
      } catch (e) {
        console.error(e);
      }
    });
  </script>
</body>
</html>
