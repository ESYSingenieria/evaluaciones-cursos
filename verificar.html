<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verificación de Insignia</title>

  <link rel="stylesheet" href="styles.css"/>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

  <!-- Tu JS principal -->
  <script src="app.js" defer></script>

  <style>
    .badge-container{
      max-width: 800px; margin: 30px auto; padding: 20px; background:#fff;
      border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1);
    }
    .badge-header{ text-align:center; margin-bottom:20px; }
    .badge-header img{ width:150px; height:auto; margin-bottom:10px; }
    .badge-content{ text-align:center; margin-bottom:20px; }
    .badge-content h2{ margin-bottom:10px; font-size:1.5rem; color:#007bff; }
    .badge-content p{ margin-bottom:15px; color:#555; }
    .badge-criteria, .badge-standards{ margin-top:25px; }
    .badge-criteria h3, .badge-standards h3{ color:#333; margin-bottom:10px; font-size:1.1rem; }
    .badge-criteria ul, .badge-standards ul{
      list-style: none; padding:0; margin:0;
    }
    .badge-criteria ul li, .badge-standards ul li{
      background:#f9f9f9; margin-bottom:10px; padding:10px;
      border-radius:5px; box-shadow:0 1px 4px rgba(0,0,0,.1);
    }
    .badge-footer{ text-align:center; margin-top:30px; }
    .badge-footer button{
      background-color:#28a745; color:#fff; border:0; padding:10px 20px;
      border-radius:5px; cursor:pointer; font-size:16px;
    }
    .badge-footer button:hover{ background-color:#218838; }
    .badge-footer a{ display:block; margin-top:10px; color:#007bff; text-decoration:none; font-size:14px; }
    .badge-footer a:hover{ text-decoration:underline; }

    /* ====== Buscador ====== */
    .search-wrap{
      position:relative;
      margin: 0 0 18px 0;         /* ya no toca el logo */
    }
    .search-input{
      width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; font-size:16px; outline:none;
    }
    .search-input:focus{ border-color:#007bff; box-shadow:0 0 0 3px rgba(0,123,255,.15); }
    .search-results{
      position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #e5e7eb;
      border-top:none; border-radius:0 0 12px 12px; box-shadow:0 10px 24px rgba(0,0,0,.08);
      max-height:360px; overflow:auto; display:none; z-index:50;
    }
    .search-results.open{ display:block; }
    .sr-item{ padding:10px 12px; cursor:pointer; }
    .sr-item:hover{ background:#f8fafc; }
    .sr-item.disabled{ cursor:default; color:#6b7280; }
    .sr-title{ font-weight:600; }
    .sr-sub{ font-size:12px; color:#4b5563; }
    .sr-meta{ font-size:11px; color:#9ca3af; margin-top:2px; }
    .search-hint{ font-size:12px; color:#6b7280; margin-top:6px; }
  </style>
</head>
<body>
  <header style="text-align:center; padding:0; background:#ffffff;">
    <a href="https://esys.cl/"><img src="logo.png" alt="ESYS" style="max-width:200px;height:auto;"></a>
  </header>

  <div class="badge-container">
    <div class="search-wrap">
      <input id="globalSearch" class="search-input"
           placeholder="Buscar por CustomID (ej.: 200) o por nombre…" autocomplete="off"/>
      <div id="searchResults" class="search-results"></div>
      <div class="search-hint">Tip: si escribes solo números, se busca por CustomID y el guion se agrega automáticamente (ej.: 200 → 200-).</div>
    </div>
    
    <div class="badge-header">
      <img id="badgeImage" src="" alt="Insignia">
      <h1 id="courseName">Cargando...</h1>
    </div>

    <div class="badge-content">
      <p id="issuedTo">Cargando...</p>
      <p id="description">Cargando...</p>
    </div>

    <div class="badge-criteria">
      <h3>Criterios de Aprobación</h3>
      <ul id="criteriaList">
        <li>Cargando...</li>
      </ul>
    </div>

    <div class="badge-standards">
      <h3>Estándares</h3>
      <ul id="standardsList">
        <li>Cargando...</li>
      </ul>
    </div>

    <div class="badge-footer">
      <button onclick="window.location.href='https://esys.cl/cursos-y-capacitaciones/'">Obtener esta Insignia</button>
    </div>
  </div>

  <script>
    (function initVerifierSearchV2(){
      const input = document.getElementById('globalSearch');
      const panel = document.getElementById('searchResults');
      if(!input || !panel) return;

      // helpers
      const open  = ()=> panel.classList.add('open');
      const close = ()=> { panel.classList.remove('open'); panel.innerHTML=''; };
      const render = (items)=>{
        if(!items.length){ panel.innerHTML = '<div class="sr-item disabled">Sin resultados</div>'; open(); return; }
        panel.innerHTML = items.map(it => `
          <div class="sr-item ${it.disabled?'disabled':''}" ${it.id?`data-id="${it.id}"`:''}>
            <div class="sr-title">${it.title}</div>
            <div class="sr-sub">${it.sub||''}</div>
            ${it.meta?`<div class="sr-meta">${it.meta}</div>`:''}
          </div>
        `).join('');
        open();
      };

      // navegación por clic y enter
      panel.addEventListener('click', e=>{
        const item = e.target.closest('.sr-item');
        if(!item || item.classList.contains('disabled')) return;
        const id = item.dataset.id;
        if(id) window.location.href = `verificar.html?id=${id}`;
      });
      input.addEventListener('keydown', e=>{
        if(e.key==='Enter'){
          const first = panel.querySelector('.sr-item:not(.disabled)');
          if(first && first.dataset.id) window.location.href = `verificar.html?id=${first.dataset.id}`;
        }
      });
      document.addEventListener('click', e=>{
        if(!panel.contains(e.target) && e.target!==input) close();
      });

      // debounce
      let to=null;
      input.addEventListener('input', ()=>{
        clearTimeout(to);
        const q = input.value.trim();
        if(!q){ close(); return; }
        panel.innerHTML = '<div class="sr-item disabled">Buscando…</div>'; open();
        to = setTimeout(()=> doSearch(q), 260);
      });

      async function doSearch(raw){
        try{
          const items = [];
          const onlyDigits = /^[0-9]+$/.test(raw.replace(/[^\d]/g,''));

          // 1) Búsqueda por CustomID (si escribió solo números)
          if(onlyDigits){
            let cid = raw.replace(/[^\d]/g,'');
            if(!cid.endsWith('-')) cid += '-';

            // users por prefijo de customID
            const usersSnap = await db.collection('users')
              .orderBy('customID')
              .startAt(cid)
              .endAt(cid + '\uf8ff')
              .limit(5)
              .get();

            if (usersSnap.empty){
              items.push({disabled:true, title:`${cid}`, sub:'Sin usuarios con ese CustomID'});
            }else{
              // para cada usuario, traer sus certificados por nombre
              for(const uDoc of usersSnap.docs){
                const u = uDoc.data() || {};
                const uname = (u.name||'').trim();
                const uCID  = u.customID || cid;

                const certSnap = await db.collection('certificates')
                  .orderBy('name')
                  .startAt(uname)
                  .endAt(uname + '\uf8ff')
                  .limit(6)
                  .get();

                if(certSnap.empty){
                  items.push({disabled:true, title:`${uCID} — ${uname}`, sub:'Sin certificados asociados'});
                }else{
                  certSnap.forEach(c=>{
                    const d = c.data() || {};
                    items.push({
                      id: c.id,
                      title: d.courseName || 'Curso',
                      sub: `${uCID} — ${d.name || uname}`,
                      meta: `ID certificado: ${c.id}`
                    });
                  });
                }
              }
            }
          }

          // 2) Búsqueda por NOMBRE (si hay letras o como complemento)
          const term = raw;
          const certByName = await db.collection('certificates')
            .orderBy('name')
            .startAt(term)
            .endAt(term + '\uf8ff')
            .limit(8)
            .get();

          certByName.forEach(doc=>{
            const d = doc.data()||{};
            items.push({
              id: doc.id,
              title: d.courseName || 'Curso',
              sub: d.name || '',
              meta: `ID certificado: ${doc.id}`
            });
          });

          // quitar duplicados por ID
          const seen=new Set(); const uniq=[];
          for(const it of items){
            if(!it.id){ uniq.push(it); continue; }
            if(seen.has(it.id)) continue;
            seen.add(it.id); uniq.push(it);
          }

          render(uniq.slice(0,12));
        }catch(err){
          console.error('Search error:', err);
          render([{disabled:true, title:'Error de búsqueda', sub:'Intenta nuevamente'}]);
        }
      }
    })();
    document.addEventListener('DOMContentLoaded', () => {
      try {
        if (typeof loadBadgeData === 'function') {
          loadBadgeData(); // carga la insignia usando ?id=...
        } else {
          console.error('loadBadgeData no está definida');
        }
      } catch (e) {
        console.error(e);
      }
    });
  </script>
</body>
</html>
